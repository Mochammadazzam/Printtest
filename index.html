<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BT Tester Pro</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f8fafc; color: #1e293b; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .log-area { background: #0f172a; color: #38bdf8; padding: 15px; border-radius: 10px; height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; border: 2px solid #334155; }
        button { width: 100%; padding: 15px; margin: 8px 0; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-primary:active, .btn-success:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <h2 style="text-align: center;">PRINTER TESTER PRO</h2>
    
    <div class="card">
        <button class="btn-primary" onclick="startProcess()">MULAI SCAN & KONEK</button>
        <button class="btn-success" onclick="testPrint()">TEST CETAK (AUTO-UUID)</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <strong>System Log:</strong>
            <small id="status-bt">ðŸ”´ Off</small>
        </div>
        <div id="log" class="log-area">Ready...<br></div>
    </div>

    <script>
        let deviceId = null;
        let targetService = null;
        let targetChar = null;
        let canWriteWithoutResponse = false;

        function writeLog(msg, color = "#38bdf8") {
            const log = document.getElementById('log');
            log.innerHTML += `<span style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</span><br>`;
            log.scrollTop = log.scrollHeight;
        }

        async function startProcess() {
            try {
                const BleClient = window.Capacitor.Plugins.BluetoothLe;
                writeLog("Inisialisasi Bluetooth...");
                await BleClient.initialize();
                document.getElementById('status-bt').innerText = "ðŸ”µ On";

                writeLog("Mencari Printer...");
                const device = await BleClient.requestDevice({ acceptAllDevices: true });
                deviceId = device.deviceId;
                writeLog("Device Terpilih: " + device.name, "#10b981");

                writeLog("Menyambungkan...");
                await BleClient.connect({ deviceId });
                writeLog("Tersambung!", "#10b981");

                writeLog("Scanning UUID & Services...");
                const result = await BleClient.getServices({ deviceId });
                
                // --- LOGIKA AUTO-DISCOVERY (KUNCI ANTI FORCE CLOSE) ---
                let found = false;
                result.forEach(s => {
                    s.characteristics.forEach(c => {
                        // Cari yang mendukung WRITE atau WRITE_WITHOUT_RESPONSE
                        if (c.properties.write || c.properties.writeWithoutResponse) {
                            if (!found) {
                                targetService = s.uuid;
                                targetChar = c.uuid;
                                canWriteWithoutResponse = c.properties.writeWithoutResponse;
                                found = true;
                                writeLog(`DITEMUKAN JALUR: ${c.uuid.slice(4,8)}`, "#f59e0b");
                            }
                        }
                    });
                });

                if (found) writeLog("Printer Siap Digunakan!", "#10b981");
                else writeLog("Karakteristik Write Tidak Ditemukan!", "#ef4444");

            } catch (e) {
                writeLog("ERROR: " + e.message, "#ef4444");
            }
        }

        async function testPrint() {
            if (!deviceId || !targetChar) return writeLog("Konek dulu!", "#ef4444");

            try {
                const BleClient = window.Capacitor.Plugins.BluetoothLe;
                writeLog("Menyiapkan Data...");
                
                const text = "\x1B@\x1Ba\x01TEST CETAK BERHASIL\nAUTO UUID DETECTED\n----------------\n\n\n\n";
                const data = new TextEncoder().encode(text);
                
                writeLog("Mengirim (Chunking 20 bytes)...");
                for (let i = 0; i < data.length; i += 20) {
                    const chunk = data.slice(i, i + 20);
                    const base64 = btoa(String.fromCharCode(...chunk));
                    
                    const options = {
                        deviceId,
                        service: targetService,
                        characteristic: targetChar,
                        value: base64
                    };

                    if (canWriteWithoutResponse) {
                        await BleClient.writeWithoutResponse(options);
                    } else {
                        await BleClient.write(options);
                    }
                    
                    writeLog(`Sent part ${Math.floor(i/20)+1}...`);
                    await new Promise(r => setTimeout(r, 40));
                }
                writeLog("CETAK SELESAI!", "#10b981");
            } catch (e) {
                writeLog("CRASH TERCEGAH: " + e.message, "#ef4444");
            }
        }
    </script>
</body>
</html>
