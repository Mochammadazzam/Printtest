<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suka Laundry - BT Diagnostic</title>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f0f4f8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button { padding: 12px 5px; border: none; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; background: #4b5563; }
        .btn-ready { background: #2563eb; }
        .btn-action { background: #059669; }
        .btn-danger { background: #dc2626; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 10px; border: 2px solid #333; }
        .section-title { font-size: 10px; font-weight: bold; color: #666; margin: 10px 0 5px 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <h4 style="margin: 5px 0; text-align: center;">SUKA LAUNDRY PRO (FIX ANDROID 12+)</h4>

    <div class="section-title">1. System & Permissions</div>
    <div class="grid">
        <button class="btn-ready" onclick="safeRun(checkPermissions)">1. CEK IZIN</button>
        <button class="btn-ready" onclick="safeRun(requestPermissions)">2. MINTA IZIN</button>
    </div>

    <div class="section-title">2. Module Initialization</div>
    <div class="grid">
        <button class="btn-ready" onclick="safeRun(initModule)">3. INIT (NO LOCATION)</button>
        <button class="btn-ready" onclick="safeRun(checkStatus)">4. CEK STATUS BT</button>
    </div>

    <div class="section-title">3. Connection</div>
    <div class="grid">
        <button class="btn-action" onclick="safeRun(scanPrinter)">5. SCAN PRINTER</button>
        <button class="btn-action" onclick="safeRun(connectPrinter)">6. KONEK PRINTER</button>
    </div>

    <div class="section-title">4. Data (EPPOS Standard)</div>
    <div class="grid">
        <button class="btn-danger" onclick="safeRun(testHeartbeat)">7. TES 1 BYTE</button>
        <button class="btn-danger" onclick="safeRun(testPrintFull)">8. CETAK STRUK</button>
    </div>

    <div id="log-box" class="log">Ready...<br></div>

    <script>
        const BleClient = window.Capacitor.Plugins.BluetoothLe;
        
        // UUID Standar SPP untuk EPPOS RPP02 sesuai dokumentasi dan log Anda
        const SERVICE_UUID = '00001101-0000-1000-8000-00805f9b34fb';
        const CHARACTERISTIC_UUID = '00001101-0000-1000-8000-00805f9b34fb'; 
        
        let selectedId = null;

        function writeLog(msg, isError = false) {
            const box = document.getElementById('log-box');
            const color = isError ? "#ff4444" : "#00ff00";
            box.innerHTML += `<span style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</span><br>`;
            box.scrollTop = box.scrollHeight;
        }

        async function safeRun(func) {
            try {
                await func();
            } catch (e) {
                writeLog("ERROR: " + e.message, true);
                alert("Proses Gagal: " + e.message);
            }
        }

        async function checkPermissions() {
            const s = await BleClient.checkPermissions();
            writeLog("Status Izin: " + JSON.stringify(s));
        }

        async function requestPermissions() {
            writeLog("Meminta izin Bluetooth...");
            await BleClient.requestPermissions();
            writeLog("Izin selesai diproses.");
        }

        async function initModule() {
            writeLog("Inisialisasi Tanpa Izin Lokasi...");
            // SESUAI DOKUMENTASI: Menggunakan flag androidNeverForLocation
            await BleClient.initialize({ androidNeverForLocation: true });
            writeLog("Modul Bluetooth Siap.");
        }

        async function checkStatus() {
            const s = await BleClient.isEnabled();
            writeLog("Bluetooth HP Aktif: " + s.value);
        }

        async function scanPrinter() {
            writeLog("Mencari perangkat...");
            const device = await BleClient.requestDevice({ acceptAllDevices: true });
            selectedId = device.deviceId;
            writeLog("Terpilih: " + device.name + " (" + selectedId + ")");
        }

        async function connectPrinter() {
            if(!selectedId) throw new Error("ID Printer Kosong!");
            writeLog("Menghubungkan ke " + selectedId + "...");
            await BleClient.connect({ deviceId: selectedId });
            writeLog("TERHUBUNG!");
        }

        async function testHeartbeat() {
            if(!selectedId) throw new Error("Belum terhubung!");
            writeLog("Mengirim 1 byte ke SPP...");
            
            // Menggunakan btoa untuk konversi ke Base64 (Standard Capacitor Write)
            const data = btoa("\n"); 
            
            await BleClient.writeWithoutResponse({
                deviceId: selectedId,
                service: SERVICE_UUID,
                characteristic: CHARACTERISTIC_UUID,
                value: data
            });
            writeLog("Data 1 Byte Terkirim.");
        }

        async function testPrintFull() {
            if(!selectedId) throw new Error("Belum terhubung!");
            writeLog("Mencetak Struk Suka Laundry...");
            
            // ESC/POS Command: Init (@) + Teks + Newline
            const text = "\x1B@SUKA LAUNDRY PRO\nTes Bluetooth Berhasil\n------------------\n\n\n\n";
            const data = btoa(text);
            
            await BleClient.writeWithoutResponse({
                deviceId: selectedId,
                service: SERVICE_UUID,
                characteristic: CHARACTERISTIC_UUID,
                value: data
            });
            writeLog("Cetak Selesai.");
        }
    </script>
</body>
</html>
