<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BT Tester Anti-Crash</title>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f0f4f8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button { padding: 12px 5px; border: none; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; background: #4b5563; }
        .btn-ready { background: #2563eb; }
        .btn-action { background: #059669; }
        .btn-danger { background: #dc2626; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 8px; height: 280px; overflow-y: auto; font-family: monospace; font-size: 10px; border: 2px solid #333; }
        .section-title { font-size: 10px; font-weight: bold; color: #666; margin: 10px 0 5px 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <h4 style="margin: 5px 0; text-align: center;">BT DIAGNOSTIC V2 (ANTI-CRASH)</h4>

    <div class="section-title">1. System & Permissions</div>
    <div class="grid">
        <button class="btn-ready" onclick="safeRun(checkPermissions)">1. CEK IZIN</button>
        <button class="btn-ready" onclick="safeRun(requestPermissions)">2. MINTA IZIN</button>
    </div>

    <div class="section-title">2. Module Initialization</div>
    <div class="grid">
        <button class="btn-ready" onclick="safeRun(initModule)">3. INIT MODUL</button>
        <button class="btn-ready" onclick="safeRun(checkStatus)">4. CEK STATUS BT</button>
    </div>

    <div class="section-title">3. Discovery & Handshake</div>
    <div class="grid">
        <button class="btn-action" onclick="safeRun(scanPrinter)">5. SCAN PRINTER</button>
        <button class="btn-action" onclick="safeRun(connectPrinter)">6. KONEK PRINTER</button>
        <button class="btn-action" onclick="safeRun(discoverUUID)">7. DISCOVER UUID</button>
        <button class="btn-action" onclick="safeRun(getConnectedDevices)">8. LIST KONEK</button>
    </div>

    <div class="section-title">4. Data Transmission</div>
    <div class="grid">
        <button class="btn-danger" onclick="safeRun(testHeartbeat)">9. TES 1 BYTE</button>
        <button class="btn-danger" onclick="safeRun(testPrintFull)">10. CETAK STRUK</button>
    </div>

    <div class="log" id="log-box">Ready to monitor...<br></div>

        <script>
    const BleClient = window.Capacitor.Plugins.BluetoothLe;
    const SERVICE_UUID = '00001101-0000-1000-8000-00805f9b34fb';
    const CHARACTERISTIC_UUID = '00002a00'; 
    let selectedId = null;
    let sUUID = null; // Ini akan diisi otomatis saat klik Discover
    let cUUID = null;

        // --- GLOBAL ERROR CATCHER (Pencegah Force Close Utama) ---
        window.onerror = function(msg, url, line) {
            alert("JS ERROR: " + msg + "\nLine: " + line);
            return true; 
        };

        function writeLog(msg, isError = false) {
            const box = document.getElementById('log-box');
            const color = isError ? "#ff4444" : "#00ff00";
            box.innerHTML += `<span style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</span><br>`;
            box.scrollTop = box.scrollHeight;
        }

        // Wrapper Fungsi agar jika gagal tidak langsung mati
        async function safeRun(func) {
            try {
                await func();
            } catch (e) {
                console.error(e);
                writeLog("CRASH BLOCKED: " + e.message, true);
                alert("Aplikasi hampir Force Close! \n\nPesan: " + e.message);
            }
        }

        // --- DAFTAR FUNGSI BREAKDOWN ---

        async function checkPermissions() {
            const s = await BleClient.checkPermissions();
            writeLog("Izin: " + JSON.stringify(s));
        }

        async function requestPermissions() {
            writeLog("Meminta izin...");
            await BleClient.requestPermissions();
            writeLog("Proses Izin Selesai.");
        }

        async function initModule() {
            await BleClient.initialize();
            writeLog("Modul Bluetooth Inisialisasi.");
        }

        async function checkStatus() {
            const s = await BleClient.isEnabled();
            writeLog("Bluetooth Aktif: " + s.value);
        }

        async function scanPrinter() {
            const device = await BleClient.requestDevice({ acceptAllDevices: true });
            selectedId = device.deviceId;
            writeLog("Terpilih: " + device.name + " (" + selectedId + ")");
        }

        async function connectPrinter() {
            if(!selectedId) throw new Error("ID Printer Kosong!");
            writeLog("Menyambungkan...");
            await BleClient.connect({ deviceId: selectedId });
            writeLog("Status: Terhubung!");
        }

        async function discoverUUID() {
            if(!selectedId) throw new Error("Koneksi belum ada.");
            writeLog("Scanning Services...");
            const res = await BleClient.getServices({ deviceId: selectedId });
            
            let found = false;
            if (res && res.services) {
                res.services.forEach(s => {
                    s.characteristics.forEach(c => {
                        if (c.properties.write || c.properties.writeWithoutResponse) {
                            if(!found) {
                                sUUID = s.uuid;
                                cUUID = c.uuid;
                                found = true;
                                writeLog("Ditemukan Jalur: " + c.uuid.slice(0,8));
                            }
                        }
                    });
                });
            }
            if(!found) writeLog("Gagal: Karakteristik Write Tidak Ada.", true);
        }

        async function getConnectedDevices() {
            const list = await BleClient.getConnectedDevices();
            writeLog("Device Terhubung: " + JSON.stringify(list));
        }

        async function testHeartbeat() {
            if(!cUUID) throw new Error("Jalur UUID belum ada.");
            writeLog("Kirim Heartbeat (1 byte)...");
            const data = btoa("\n");
            await BleClient.writeWithoutResponse({
                deviceId: selectedId, service: sUUID, characteristic: cUUID, value: data
            });
            writeLog("Heartbeat Terkirim.");
        }

        async function testPrintFull() {
            if(!cUUID) throw new Error("Jalur UUID belum ada.");
            writeLog("Mengirim Struk Full...");
            const text = "\x1B@TES CETAK SUKSES\n\n\n\n";
            const data = btoa(text);
            await BleClient.writeWithoutResponse({
                deviceId: selectedId, service: sUUID, characteristic: cUUID, value: data
            });
            writeLog("Struk Terkirim.");
        }
    </script>
</body>
</html>
