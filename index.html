<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suka Laundry - EPPOS Fix</title>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f0f4f8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button { padding: 12px 5px; border: none; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; background: #4b5563; }
        .btn-ready { background: #2563eb; }
        .btn-action { background: #059669; }
        .btn-danger { background: #dc2626; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 10px; border: 2px solid #333; }
        .section-title { font-size: 10px; font-weight: bold; color: #666; margin: 10px 0 5px 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <h4 style="margin: 5px 0; text-align: center;">SUKA LAUNDRY PRO (FIX 1101)</h4>

    <div class="section-title">1. Tahap Inisialisasi</div>
    <div class="grid">
        <button class="btn-ready" onclick="safeRun(requestPermissions)">1. MINTA IZIN</button>
        <button class="btn-ready" onclick="safeRun(initModule)">2. INIT (NO LOCATION)</button>
    </div>

    <div class="section-title">2. Tahap Koneksi</div>
    <div class="grid">
        <button class="btn-action" onclick="scanPrinter()">3. CARI PRINTER</button>
        <button class="btn-action" onclick="connectPrinter()">4. SAMBUNGKAN</button>
    </div>

    <div class="section-title">3. Tahap Cetak</div>
    <div class="grid">
        <button class="btn-danger" onclick="testHeartbeat()">5. TES JALUR 1101</button>
        <button class="btn-danger" onclick="testPrintFull()">6. CETAK STRUK</button>
    </div>

    <div id="log-box" class="log">Menunggu instruksi...<br></div>

    <script>
        const BleClient = window.Capacitor.Plugins.BluetoothLe;
        
        // UUID SPP Universal untuk Printer Thermal EPPOS
        const SERVICE_UUID = '00001101-0000-1000-8000-00805f9b34fb';
        const CHARACTERISTIC_UUID = '00001101-0000-1000-8000-00805f9b34fb'; 
        
        let selectedId = null;

        function writeLog(msg, isError = false) {
            const box = document.getElementById('log-box');
            const color = isError ? "#ff4444" : "#00ff00";
            box.innerHTML += `<span style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</span><br>`;
            box.scrollTop = box.scrollHeight;
        }

        async function safeRun(func) {
            try { await func(); } catch (e) {
                writeLog("ERROR: " + e.message, true);
            }
        }

        async function requestPermissions() {
            writeLog("Memproses Izin Bluetooth...");
            await BleClient.requestPermissions();
            writeLog("Izin OK.");
        }

        async function initModule() {
            writeLog("Inisialisasi Tanpa Lokasi (Android 12+)...");
            // Sesuai dokumen: androidNeverForLocation: true
            await BleClient.initialize({ androidNeverForLocation: true });
            writeLog("Modul Bluetooth Siap.");
        }

        async function scanPrinter() {
            writeLog("Membuka daftar perangkat...");
            const device = await BleClient.requestDevice({ acceptAllDevices: true });
            selectedId = device.deviceId;
            writeLog("Terpilih: " + device.name + " (" + selectedId + ")");
        }

        async function connectPrinter() {
            if(!selectedId) throw new Error("Pilih printer dulu!");
            writeLog("Menyambungkan...");
            await BleClient.connect({ deviceId: selectedId });
            writeLog("TERHUBUNG KE PRINTER!");
        }

        async function testHeartbeat() {
            if(!selectedId) throw new Error("Belum tersambung!");
            writeLog("Mencoba kirim 1 byte ke Jalur 1101...");
            const data = btoa("\n"); 
            await BleClient.writeWithoutResponse({
                deviceId: selectedId,
                service: SERVICE_UUID,
                characteristic: CHARACTERISTIC_UUID,
                value: data
            });
            writeLog("Jalur 1101 Aktif! Printer harusnya merespon.");
        }

        async function testPrintFull() {
            if(!selectedId) throw new Error("Belum tersambung!");
            writeLog("Mencetak Struk...");
            const text = "\x1B@   SUKA LAUNDRY PRO\n----------------------\nPrinter EPPOS Berhasil!\n\n\n\n";
            const data = btoa(text);
            await BleClient.writeWithoutResponse({
                deviceId: selectedId,
                service: SERVICE_UUID,
                characteristic: CHARACTERISTIC_UUID,
                value: data
            });
            writeLog("Cetak selesai.");
        }
    </script>
</body>
</html>
