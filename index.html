<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suka Laundry Pro - Ultimate Printer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #eef2f3; color: #333; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 5px; }
        p { text-align: center; font-size: 12px; color: #666; margin-bottom: 25px; }
        .btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-success { background: #34a853; color: white; box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3); }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        #status-box { background: #1e293b; color: #00ff41; padding: 15px; border-radius: 10px; height: 150px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; margin-top: 20px; border-left: 4px solid #1a73e8; }
        .divider { height: 1px; background: #ddd; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h2>SUKA LAUNDRY</h2>
        <p>POS Printer System v2.0</p>
        
        <button class="btn btn-primary" onclick="startSystem()">1. INITIALIZE & SCAN</button>
        <button class="btn btn-primary" onclick="connectToPrinter()">2. CONNECT PRINTER</button>
        
        <div class="divider"></div>
        
        <button class="btn btn-success" onclick="printPowerfull()">3. CETAK STRUK (NATIVE LOGIC)</button>
        
        <div id="status-box">Menunggu perintah Azzam...<br></div>
    </div>

    <script>
        const BleClient = window.Capacitor.Plugins.BluetoothLe;
        const SPP_UUID = '00001101-0000-1000-8000-00805f9b34fb';
        let deviceId = null;

        function log(msg) {
            const box = document.getElementById('status-box');
            box.innerHTML += `> ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
        }

        async function startSystem() {
            try {
                log("Memulai modul (No Location Mode)...");
                await BleClient.initialize({ androidNeverForLocation: true });
                
                log("Meminta Izin Bluetooth...");
                await BleClient.requestPermissions();
                
                log("Mencari Printer...");
                const device = await BleClient.requestDevice({ acceptAllDevices: true });
                deviceId = device.deviceId;
                log(`Terpilih: ${device.name || 'Unknown Device'}`);
            } catch (e) { log(`Error: ${e.message}`); }
        }

        async function connectToPrinter() {
            if (!deviceId) return alert("Pilih printer dulu di langkah 1!");
            try {
                log("Menyambungkan Socket RFCOMM...");
                await BleClient.connect({ deviceId });
                log("STATUS: TERHUBUNG KE EPPOS.");
            } catch (e) { log(`Gagal: ${e.message}`); }
        }

        // FUNGSI POWERFULL: GABUNGAN LOGIKA NATIVE + PRAWITO
        async function printPowerfull() {
            if (!deviceId) return alert("Koneksi belum siap!");
            try {
                log("Menyusun Byte Data...");
                const encoder = new TextEncoder();

                // 1. HEADER (Logika Native Java: Blank Lines)
                const initCmd = new Uint8Array([0x1B, 0x40]); // ESC @ (Reset)
                const alignCenter = new Uint8Array([0x1B, 0x61, 0x01]); // ESC a 1 (Center)
                const alignLeft = new Uint8Array([0x1B, 0x61, 0x00]); // ESC a 0 (Left)
                const boldOn = new Uint8Array([0x1B, 0x45, 0x01]); // ESC E 1 (Bold On)
                const boldOff = new Uint8Array([0x1B, 0x45, 0x00]); // ESC E 0 (Bold Off)

                // 2. TEXT CONTENT (Logika Prawito: Spacing & Separator)
                const headerText = encoder.encode("SUKA LAUNDRY PRO\n");
                const subHeader = encoder.encode("Cepat - Bersih - Wangi\n");
                const line = encoder.encode("================================\n");
                
                const bodyText = encoder.encode(
                    "Pelanggan : Azzam\n" +
                    "Tanggal   : 08-02-2026\n" +
                    "--------------------------------\n" +
                    "Paket     : Cuci Kering\n" +
                    "Berat     : 5 Kg\n" +
                    "Total     : Rp 35.000\n" +
                    "--------------------------------\n"
                );
                
                const footerText = encoder.encode("   TERIMA KASIH BANYAK\n\n");
                
                // 3. FEEDING (Logika Prawito: Agar kertas keluar cukup panjang)
                const feed = encoder.encode("\n\n\n\n\n");

                // GABUNGKAN SEMUA BYTE
                const payload = new Uint8Array([
                    ...initCmd, 
                    ...alignCenter, ...boldOn, ...headerText, ...boldOff,
                    ...subHeader, ...line,
                    ...alignLeft, ...bodyText,
                    ...alignCenter, ...footerText,
                    ...feed
                ]);

                // KONVERSI KE BASE64 (Syarat Capacitor)
                const base64Data = btoa(String.fromCharCode(...payload));

                log("Mengirim Stream Byte ke Motor...");
                await BleClient.write({
                    deviceId,
                    service: SPP_UUID,
                    characteristic: SPP_UUID, // SPP mode menggunakan UUID yang sama
                    value: base64Data
                });
                log("CETAK BERHASIL!");

            } catch (e) { log(`Crash: ${e.message}`); }
        }
    </script>
</body>
</html>
